<div class="verification-container">
  <header>
    <h1>Device Verification System</h1>
    <button class="logout-btn" (click)="logout()">Logout</button>
  </header>

  <main>
    <!-- Device Type Selection -->
    <div class="device-type-section" [class.disabled]="validationFailed">
      <h3>Select Device Type to Test:</h3>
      <div class="device-type-options">
        <label class="radio-label">
          <input
            type="radio"
            name="deviceType"
            value="tydenbrooks"
            [(ngModel)]="verificationData.selectedDeviceType"
            (change)="onDeviceTypeChange()"
            [disabled]="validationFailed">
          <span class="radio-text">Tydenbrooks Device</span>
        </label>
        <label class="radio-label">
          <input
            type="radio"
            name="deviceType"
            value="vynd"
            [(ngModel)]="verificationData.selectedDeviceType"
            (change)="onDeviceTypeChange()"
            [disabled]="validationFailed">
          <span class="radio-text">Vynd Device</span>
        </label>
      </div>
      <div class="device-warning" *ngIf="!verificationData.selectedDeviceType">
        ‚ö†Ô∏è Please select a device type to test
      </div>
    </div>

    <!-- Step 1: Quectel IMEI Scan -->
    <div class="step-section" [class.active]="currentStep === 'quectel'">
      <div class="step-header">
        <h2>
          <span class="step-number">1</span>
          Scan Quectel Module IMEI
        </h2>
        <div class="step-status" *ngIf="verificationData.quectelImei">‚úÖ Complete</div>
      </div>
      
      <div class="scan-input-section">
        <label for="quectel-input">Use barcode scanner to scan Quectel data:</label>
        <input
          #quectelInput
          type="text"
          id="quectel-input"
          [(ngModel)]="verificationData.quectelImei"
          (input)="onQuectelScan()"
          placeholder="Scan or enter complete Quectel data"
          class="scan-input"
          [disabled]="validationFailed"
          [class.completed]="verificationData.quectelImei.length >= 15">
        
        <div class="input-status">
          <div *ngIf="verificationData.quectelImei.length > 0 && verificationData.quectelImei.length < 15"
               class="warning">
            IMEI must be at least 15 digits (current: {{verificationData.quectelImei.length}})
          </div>
          <div *ngIf="verificationData.quectelImei.length >= 15" class="success">
            ‚úÖ Complete Quectel Data: {{verificationData.quectelFullData || verificationData.quectelImei}}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Enclosure QR Code Scan -->
    <div class="step-section" [class.active]="currentStep === 'enclosure'" [class.disabled]="currentStep === 'quectel'">
      <div class="step-header">
        <h2>
          <span class="step-number">2</span>
          Scan Enclosure QR Code
        </h2>
        <div class="step-status" *ngIf="verificationData.enclosureQrUrl">‚úÖ Complete</div>
      </div>
      
      <div class="scan-input-section">
        <label for="enclosure-input">Scan QR code from device enclosure:</label>
        <input
          #enclosureInput
          type="text"
          id="enclosure-input"
          [(ngModel)]="verificationData.enclosureQrUrl"
          (paste)="onEnclosureQrScan()"
          (input)="onEnclosureQrInput()"
          (keydown.enter)="onEnclosureQrScan()"
          placeholder="Scan QR code URL"
          class="scan-input"
          [disabled]="currentStep === 'quectel' || validationFailed"
          [class.completed]="verificationData.enclosureQrUrl">
        
        <div class="input-status" *ngIf="verificationData.enclosureQrUrl">
          <div *ngIf="verificationData.enclosureQrFullData" class="scanned-data">
            <strong>Complete Scanned Data:</strong> {{verificationData.enclosureQrFullData}}
          </div>
          <div class="url-validation">
            <div [class.success]="verificationData.urlFormatValid"
                 [class.error]="verificationData.urlFormatValid === false">
              URL Format:
              <span *ngIf="verificationData.urlFormatValid">‚úÖ Valid</span>
              <span *ngIf="verificationData.urlFormatValid === false">‚ùå Invalid (Does not match selected device types)</span>
            </div>
            <div *ngIf="verificationData.validatedDevice" class="validated-device">
              Validated as: <strong>{{verificationData.validatedDevice === 'tydenbrooks' ? 'Tydenbrooks' : 'Vynd'}} Device</strong>
            </div>
            <div *ngIf="verificationData.enclosureImei" class="extracted-imei">
              Extracted IMEI: {{verificationData.enclosureImei}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Validation Failure Alert -->
    <div class="validation-failure-section" *ngIf="validationFailed">
      <div class="validation-header failure">
        <h2 class="failure-title">‚ùå VALIDATION FAILED</h2>
        <p class="validation-subtitle">Device verification unsuccessful</p>
      </div>

      <div class="failure-results-container">
        <!-- Failure Results -->
        <div class="main-results">
          <div class="result-card error" *ngIf="verificationData.imeiMatches === false">
            <div class="result-icon">
              <span class="large-icon">‚ùå</span>
            </div>
            <div class="result-content">
              <h4>IMEI VERIFICATION</h4>
              <p class="result-status error">MISMATCH DETECTED</p>
              <p class="result-detail">The Quectel module data does not match the enclosure QR code data</p>
            </div>
          </div>

          <div class="result-card error" *ngIf="verificationData.urlFormatValid === false">
            <div class="result-icon">
              <span class="large-icon">‚ùå</span>
            </div>
            <div class="result-content">
              <h4>QR CODE URL</h4>
              <p class="result-status error">INVALID FORMAT</p>
              <p class="result-detail">URL does not match the selected {{verificationData.selectedDeviceType === 'tydenbrooks' ? 'Tydenbrooks' : 'Vynd'}} device pattern</p>
            </div>
          </div>
        </div>

        <!-- Failure Details -->
        <div class="detailed-info error-info">
          <h3>Verification Details</h3>

          <!-- Failure Reason -->
          <div class="failure-reason-box" *ngIf="verificationData.failureReason">
            <h4>‚ùå Failure Reason:</h4>
            <p class="failure-text">{{verificationData.failureReason}}</p>
          </div>

          <div class="info-grid">
            <div class="info-item" *ngIf="verificationData.quectelFullData">
              <span class="info-label">Scanned Quectel Data:</span>
              <span class="info-value mono">{{verificationData.quectelFullData}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.expectedUrl">
              <span class="info-label">Expected QR URL:</span>
              <span class="info-value small expected">{{verificationData.expectedUrl}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.enclosureQrFullData">
              <span class="info-label">Actually Scanned QR URL:</span>
              <span class="info-value small actual">{{verificationData.enclosureQrFullData}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.selectedDeviceType">
              <span class="info-label">Selected Device Type:</span>
              <span class="info-value">{{verificationData.selectedDeviceType === 'tydenbrooks' ? 'Tydenbrooks' : 'Vynd'}}</span>
            </div>
          </div>
        </div>

        <div class="failure-actions">
          <button class="primary-btn large-btn" (click)="restartVerification()">
            üîÑ Restart Verification
          </button>
          <button class="secondary-btn large-btn" (click)="startNewVerification()">
            üì± Start New (Change Device Type)
          </button>
        </div>
      </div>
    </div>

    <!-- Validation Results -->
    <div class="validation-section success-validation" *ngIf="(currentStep === 'files' || currentStep === 'complete') && !validationFailed">
      <div class="validation-header">
        <h2 class="success-title">‚úÖ VALIDATION PASSED</h2>
        <p class="validation-subtitle">All checks completed successfully</p>
      </div>

      <div class="validation-results-container">
        <!-- Main Results -->
        <div class="main-results">
          <div class="result-card" [class.success]="verificationData.imeiMatches === true || verificationData.imeiMatches === null">
            <div class="result-icon">
              <span class="large-icon" *ngIf="verificationData.imeiMatches === true">‚úÖ</span>
              <span class="large-icon" *ngIf="verificationData.imeiMatches === null">‚ÑπÔ∏è</span>
            </div>
            <div class="result-content">
              <h4>IMEI VERIFICATION</h4>
              <p class="result-status" *ngIf="verificationData.imeiMatches === true">MATCHED</p>
              <p class="result-status" *ngIf="verificationData.imeiMatches === null">NOT IN QR CODE</p>
              <p class="result-detail" *ngIf="verificationData.imeiMatches === true">Quectel module data matches enclosure QR code</p>
              <p class="result-detail" *ngIf="verificationData.imeiMatches === null">QR code contains valid URL but no IMEI for comparison</p>
            </div>
          </div>

          <div class="result-card" [class.success]="verificationData.urlFormatValid">
            <div class="result-icon">
              <span class="large-icon">‚úÖ</span>
            </div>
            <div class="result-content">
              <h4>QR CODE URL</h4>
              <p class="result-status">VALID FORMAT</p>
              <p class="result-detail">URL matches {{verificationData.validatedDevice === 'tydenbrooks' ? 'Tydenbrooks' : 'Vynd'}} device pattern</p>
            </div>
          </div>
        </div>

        <!-- Detailed Information -->
        <div class="detailed-info">
          <h3>Device Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Device Type Tested:</span>
              <span class="info-value bold">{{verificationData.validatedDevice === 'tydenbrooks' ? 'TYDENBROOKS' : 'VYND'}} DEVICE</span>
            </div>
            <div class="info-item" *ngIf="verificationData.quectelFullData">
              <span class="info-label">Scanned Quectel Data:</span>
              <span class="info-value mono">{{verificationData.quectelFullData}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.expectedUrl">
              <span class="info-label">Expected QR URL:</span>
              <span class="info-value small success">‚úÖ {{verificationData.expectedUrl}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.enclosureQrFullData">
              <span class="info-label">Actually Scanned QR URL:</span>
              <span class="info-value small success">‚úÖ {{verificationData.enclosureQrFullData}}</span>
            </div>

            <div class="info-item" *ngIf="verificationData.imeiMatches === true">
              <span class="info-label">Validation Result:</span>
              <span class="info-value success-text">‚úÖ Perfect Match - Expected and Actual URLs are identical</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: File Uploads -->
    <div class="step-section" [class.active]="currentStep === 'files'" [class.disabled]="currentStep !== 'files' && currentStep !== 'complete'">
      <div class="step-header">
        <h2>
          <span class="step-number">3</span>
          Upload Documentation
        </h2>
      </div>
      
      <div class="upload-section">
        <div class="upload-group">
          <label for="battery-file">Battery Data:</label>
          <input 
            #batteryFileInput
            type="file" 
            id="battery-file"
            (change)="onBatteryFileSelected($event)"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
            class="file-input">
          <div *ngIf="verificationData.batteryFile" class="file-status">
            ‚úÖ {{verificationData.batteryFile.name}}
          </div>
        </div>

        <div class="upload-group">
          <label for="qa-file">QA Results:</label>
          <input 
            #qaFileInput
            type="file" 
            id="qa-file"
            (change)="onQaFileSelected($event)"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
            class="file-input">
          <div *ngIf="verificationData.qaFile" class="file-status">
            ‚úÖ {{verificationData.qaFile.name}}
          </div>
        </div>
      </div>
    </div>

    <!-- Save Section -->
    <div class="save-section" *ngIf="currentStep === 'files' || currentStep === 'complete'">
      <div class="action-buttons" *ngIf="currentStep === 'files'">
        <button
          class="save-btn primary-btn"
          (click)="saveVerification()"
          [disabled]="!canSave() || isProcessing">
          <span *ngIf="!isProcessing">Save Verification</span>
          <span *ngIf="isProcessing">Saving...</span>
        </button>
        <button
          class="restart-btn secondary-btn"
          (click)="restartVerification()"
          [disabled]="isProcessing">
          Restart Verification
        </button>
      </div>
    </div>

    <!-- Complete Section -->
    <div class="complete-section" *ngIf="currentStep === 'complete'">
      <div class="success-message">
        <h3>‚úÖ Verification Complete!</h3>
        <p>All data has been saved successfully.</p>
      </div>
      
      <div class="action-buttons">
        <button class="primary-btn" (click)="startNewVerification()">
          Start New Verification
        </button>
        <button class="secondary-btn" (click)="logout()">
          Logout
        </button>
      </div>
    </div>
  </main>
</div>